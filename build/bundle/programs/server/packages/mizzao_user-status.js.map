{"version":3,"sources":["meteor://ðŸ’»app/packages/mizzao_user-status/status.coffee"],"names":[],"mappings":"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","file":"/packages/mizzao_user-status.js","sourcesContent":["###\n  Apparently, the new api.export takes care of issues here. No need to attach to global namespace.\n  See http://shiggyenterprises.wordpress.com/2013/09/09/meteor-packages-in-coffeescript-0-6-5/\n\n  We may want to make UserSessions a server collection to take advantage of indices.\n  Will implement if someone has enough online users to warrant it.\n###\nUserConnections = new Mongo.Collection(\"user_status_sessions\", { connection: null })\n\nstatusEvents = new (Npm.require('events').EventEmitter)()\n\n###\n  Multiplex login/logout events to status.online\n\n  'online' field is \"true\" if user is online, and \"false\" otherwise\n\n  'idle' field is tri-stated:\n  - \"true\" if user is online and not idle\n  - \"false\" if user is online and idle\n  - null if user is offline\n###\nstatusEvents.on \"connectionLogin\", (advice) ->\n  update =\n    $set: {\n      'status.online': true,\n      'status.lastLogin': {\n        date: advice.loginTime\n        ipAddr: advice.ipAddr\n        userAgent: advice.userAgent\n      }\n    }\n\n  # unless ALL existing connections are idle (including this new one),\n  # the user connection becomes active.\n  conns = UserConnections.find(userId: advice.userId).fetch()\n  unless _.every(conns, (c) -> c.idle)\n    update.$set['status.idle'] = false\n    update.$unset =\n      'status.lastActivity': null\n  # in other case, idle field remains true and no update to lastActivity.\n\n  Meteor.users.update advice.userId, update\n  return\n\nstatusEvents.on \"connectionLogout\", (advice) ->\n  conns = UserConnections.find(userId: advice.userId).fetch()\n  if conns.length is 0\n    # Go offline if we are the last connection for this user\n    # This includes removing all idle information\n    Meteor.users.update advice.userId,\n      $set: {'status.online': false }\n      $unset:\n        'status.idle': null\n        'status.lastActivity': null\n  else if _.every(conns, (c) -> c.idle)\n    ###\n      All remaining connections are idle:\n      - If the last active connection quit, then we should go idle with the most recent activity\n\n      - If an idle connection quit, nothing should happen; specifically, if the\n        most recently active idle connection quit, we shouldn't tick the value backwards.\n        This may result in a no-op so we can be smart and skip the update.\n    ###\n    return if advice.lastActivity? # The dropped connection was already idle\n\n    Meteor.users.update advice.userId,\n      $set:\n        'status.idle': true\n        'status.lastActivity': _.max(_.pluck conns, \"lastActivity\")\n  return\n\n###\n  Multiplex idle/active events to status.idle\n  TODO: Hopefully this is quick because it's all in memory, but we can use indices if it turns out to be slow\n\n  TODO: There is a race condition when switching between tabs, leaving the user inactive while idle goes from one tab to the other.\n  It can probably be smoothed out.\n###\nstatusEvents.on \"connectionIdle\", (advice) ->\n  conns = UserConnections.find(userId: advice.userId).fetch()\n  return unless _.every(conns, (c) -> c.idle)\n  # Set user to idle if all the connections are idle\n  # This will not be the most recent idle across a disconnection, so we use max\n\n  # TODO: the race happens here where everyone was idle when we looked for them but now one of them isn't.\n  Meteor.users.update advice.userId,\n    $set:\n      'status.idle': true\n      'status.lastActivity': _.max(_.pluck conns, \"lastActivity\")\n  return\n\nstatusEvents.on \"connectionActive\", (advice) ->\n  Meteor.users.update advice.userId,\n    $set:\n      'status.idle': false\n    $unset:\n      'status.lastActivity': null\n  return\n\n# Reset online status on startup (users will reconnect)\nonStartup = (selector = {}) ->\n  Meteor.users.update selector,\n    {\n      $set: {\n        \"status.online\": false\n      },\n      $unset: {\n        \"status.idle\": null\n        \"status.lastActivity\": null\n      }\n    },\n    { multi: true }\n\n###\n  Local session modifification functions - also used in testing\n###\n\naddSession = (connection) ->\n  UserConnections.upsert connection.id,\n    $set: {\n      ipAddr: connection.clientAddress\n      userAgent: connection.httpHeaders['user-agent']\n    }\n  return\n\nloginSession = (connection, date, userId) ->\n  UserConnections.upsert connection.id,\n    $set: {\n      userId: userId\n      loginTime: date\n    }\n\n  statusEvents.emit \"connectionLogin\",\n    userId: userId\n    connectionId: connection.id\n    ipAddr: connection.clientAddress\n    userAgent: connection.httpHeaders['user-agent']\n    loginTime: date\n  return\n\n# Possibly trigger a logout event if this connection was previously associated with a user ID\ntryLogoutSession = (connection, date) ->\n  return false unless (conn = UserConnections.findOne({\n    _id: connection.id\n    userId: { $exists: true }\n  }))?\n\n  # Yes, this is actually a user logging out.\n  UserConnections.upsert connection.id,\n    $unset: {\n      userId: null\n      loginTime: null\n    }\n\n  statusEvents.emit \"connectionLogout\",\n    userId: conn.userId\n    connectionId: connection.id\n    lastActivity: conn.lastActivity # If this connection was idle, pass the last activity we saw\n    logoutTime: date\n\nremoveSession = (connection, date) ->\n  tryLogoutSession(connection, date)\n  UserConnections.remove(connection.id)\n  return\n\nidleSession = (connection, date, userId) ->\n  UserConnections.update connection.id,\n    $set: {\n      idle: true\n      lastActivity: date\n    }\n\n  statusEvents.emit \"connectionIdle\",\n    userId: userId\n    connectionId: connection.id\n    lastActivity: date\n  return\n\nactiveSession = (connection, date, userId) ->\n  UserConnections.update connection.id,\n    $set: { idle: false }\n    $unset: { lastActivity: null }\n\n  statusEvents.emit \"connectionActive\",\n    userId: userId\n    connectionId: connection.id\n    lastActivity: date\n  return\n\n###\n  Handlers for various client-side events\n###\nMeteor.startup(onStartup)\n\n# Opening and closing of DDP connections\nMeteor.onConnection (connection) ->\n  addSession(connection)\n\n  connection.onClose ->\n    removeSession(connection, new Date())\n\n# Authentication of a DDP connection\nAccounts.onLogin (info) ->\n  loginSession(info.connection, new Date(), info.user._id)\n\n# pub/sub trick as referenced in http://stackoverflow.com/q/10257958/586086\n# We used this in the past, but still need this to detect logouts on the same connection.\nMeteor.publish null, ->\n  # Return null explicitly if this._session is not available, i.e.:\n  # https://github.com/arunoda/meteor-fast-render/issues/41\n  return [] unless @_session?\n\n  # We're interested in logout events - re-publishes for which a past connection exists\n  tryLogoutSession(@_session.connectionHandle, new Date()) unless @userId?\n\n  return []\n\n# We can use the client's timestamp here because it was sent from a TimeSync\n# value, however we should never trust it for something security dependent.\n# If timestamp is not provided (probably due to a desync), use server time.\nMeteor.methods\n  \"user-status-idle\": (timestamp) ->\n    check(timestamp, Match.OneOf(null, undefined, Date, Number) )\n\n    date = if timestamp? then new Date(timestamp) else new Date()\n    idleSession(@connection, date, @userId)\n    return\n\n  \"user-status-active\": (timestamp) ->\n    check(timestamp, Match.OneOf(null, undefined, Date, Number) )\n\n    # We only use timestamp because it's when we saw activity *on the client*\n    # as opposed to just being notified it. It is probably more accurate even if\n    # a dozen ms off due to the latency of sending it to the server.\n    date = if timestamp? then new Date(timestamp) else new Date()\n    activeSession(@connection, date, @userId)\n    return\n\n# Exported variable\nUserStatus =\n  connections: UserConnections\n  events: statusEvents\n\n# Internal functions, exported for testing\nStatusInternals = {\n  onStartup,\n  addSession,\n  removeSession,\n  loginSession,\n  tryLogoutSession,\n  idleSession,\n  activeSession,\n}\n"]}